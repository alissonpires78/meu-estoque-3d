<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Imprimir Etiqueta - Filamento</title>
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 1.5rem;
    }
    .container {
      max-width: 420px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.25rem;
      margin: 0 0 1rem;
      color: #f8fafc;
    }
    .label-preview {
      background: #fff;
      color: #0f172a;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .label-preview #qrcode {
      display: flex;
      justify-content: center;
      margin-bottom: 0.75rem;
    }
    .label-preview #qrcode canvas,
    .label-preview #qrcode img {
      display: block;
    }
    .label-info {
      text-align: center;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .label-info .name { font-weight: 700; font-size: 1rem; }
    .label-info .color { margin-top: 0.25rem; }
    .label-info .weight { margin-top: 0.25rem; color: #64748b; }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-primary {
      background: #6366f1;
      color: #fff;
    }
    .btn-primary:hover { background: #4f46e5; }
    .btn-outline {
      background: transparent;
      color: #94a3b8;
      border: 1px solid #475569;
    }
    .btn-outline:hover { background: #334155; color: #e2e8f0; }
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #64748b;
    }
    .empty-state a { color: #6366f1; }
    @media print {
      body { background: #fff; color: #000; padding: 0; }
      .actions, .container h1, .back-link { display: none !important; }
      .label-preview { box-shadow: none; border: 1px solid #ccc; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Etiqueta do filamento</h1>
    <div id="content">
      <div class="label-preview" id="labelArea">
        <div id="qrcode"></div>
        <div class="label-info" id="labelInfo"></div>
      </div>
      <div class="actions">
        <button type="button" class="btn btn-primary" id="btnPrint" title="Imprimir na impressora">
          üñ®Ô∏è Imprimir
        </button>
        <button type="button" class="btn btn-outline" id="btnPdf">
          üìÑ Salvar PDF
        </button>
        <button type="button" class="btn btn-outline" id="btnPng">
          üñºÔ∏è Salvar PNG
        </button>
      </div>
    </div>
    <div id="empty" class="empty-state" style="display:none;">
      <p>Nenhum dado de filamento na URL.</p>
      <p><a href="./index.html">Voltar ao app</a></p>
    </div>
  </div>

  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const qrCodeValue = params.get('qr') || params.get('qrCode') || '';
      const name = (params.get('name') || params.get('nome') || '');
      const color = (params.get('color') || params.get('cor') || '');
      const material = (params.get('material') || '');
      const decode = function(s) { try { return s ? decodeURIComponent(s) : ''; } catch(e) { return s || ''; } };
      const nameDec = decode(name);
      const colorDec = decode(color);
      const materialDec = decode(material);
      const weightRemaining = params.get('weightRemaining') || params.get('peso') || '';
      const weightTotal = params.get('weightTotal') || '';

      const contentEl = document.getElementById('content');
      const emptyEl = document.getElementById('empty');
      const labelInfoEl = document.getElementById('labelInfo');
      const qrcodeContainer = document.getElementById('qrcode');

      if (!qrCodeValue) {
        contentEl.style.display = 'none';
        emptyEl.style.display = 'block';
        return;
      }

      // Gerar QR Code (qrcodejs - davidshimjs)
      try {
        qrcodeContainer.innerHTML = '';
        new QRCode(qrcodeContainer, {
          text: qrCodeValue,
          width: 160,
          height: 160,
          colorDark: '#000000',
          colorLight: '#ffffff'
        });
      } catch (e) {
        qrcodeContainer.innerHTML = '<p style="color:#b91c1c;">Erro ao gerar QR Code.</p>';
      }

      const infoLines = [];
      if (nameDec) infoLines.push('<span class="name">' + escapeHtml(nameDec) + '</span>');
      if (colorDec) infoLines.push('<span class="color">' + escapeHtml(colorDec) + '</span>');
      if (materialDec) infoLines.push('<span class="material">' + escapeHtml(materialDec) + '</span>');
      if (weightRemaining || weightTotal) {
        const w = weightRemaining && weightTotal ? weightRemaining + ' / ' + weightTotal + ' g' : (weightRemaining || weightTotal) + ' g';
        infoLines.push('<span class="weight">' + escapeHtml(w) + '</span>');
      }
      labelInfoEl.innerHTML = infoLines.length ? infoLines.join('') : '';

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function getLabelElement() {
        return document.getElementById('labelArea');
      }

      document.getElementById('btnPrint').onclick = function() {
        window.print();
      };

      function getQrDataUrl() {
        const qrEl = document.getElementById('qrcode');
        const canvas = qrEl.querySelector('canvas');
        if (canvas) return canvas.toDataURL('image/png');
        const img = qrEl.querySelector('img');
        if (img && img.src) return img.src;
        return null;
      }

      document.getElementById('btnPdf').onclick = function() {
        const el = getLabelElement();
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit: 'mm', format: [70, 50] });
        const w = pdf.internal.pageSize.getWidth();
        const qrDataUrl = getQrDataUrl();
        if (qrDataUrl) {
          const qrSize = 25;
          pdf.addImage(qrDataUrl, 'PNG', (w - qrSize) / 2, 4, qrSize, qrSize);
        }
        const text = [nameDec, colorDec, materialDec].filter(Boolean).join(' | ');
        if (text) {
          pdf.setFontSize(8);
          pdf.text(text, w / 2, 32, { align: 'center', maxWidth: w - 4 });
        }
        pdf.save('etiqueta-filamento.pdf');
      };

      document.getElementById('btnPng').onclick = function() {
        const el = getLabelElement();
        const qrEl = el.querySelector('#qrcode');
        const rect = el.getBoundingClientRect();
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(rect.width);
        canvas.height = Math.round(rect.height);
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        const qrDataUrl = getQrDataUrl();
        if (qrDataUrl) {
          const img = new Image();
          img.onload = function() {
            const qrSize = Math.min(160, rect.width - 40);
            const x = (canvas.width - qrSize) / 2;
            ctx.drawImage(img, x, 20, qrSize, qrSize);
            const text = [nameDec, colorDec, materialDec].filter(Boolean).join(' | ');
            if (text) {
              ctx.fillStyle = '#000';
              ctx.font = '14px system-ui, sans-serif';
              ctx.textAlign = 'center';
              ctx.fillText(text, canvas.width / 2, 20 + qrSize + 24);
            }
            const a = document.createElement('a');
            a.download = 'etiqueta-filamento.png';
            a.href = canvas.toDataURL('image/png');
            a.click();
          };
          img.src = qrDataUrl;
        } else {
          const a = document.createElement('a');
          a.download = 'etiqueta-filamento.png';
          a.href = canvas.toDataURL('image/png');
          a.click();
        }
      };
    })();
  </script>
</body>
</html>
