<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Estoque 3D - Gerenciador de Filamentos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.1.4/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --danger: #ff6b6b;
            --success: #51cf66;
            --warning: #fbbf24;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
            --gray: #6b7280;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--dark);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        header h1 {
            font-size: 2em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            background: white;
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 10px 20px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        input, select, textarea {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95em;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-top: 5px solid var(--primary);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .card-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border-top: 4px solid var(--primary);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .slot-group {
            background: var(--light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .slot-label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        #scanner {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .scan-result {
            background: var(--light);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé® Meu Estoque 3D</h1>
            <button class="btn-primary" onclick="openAddModal()">+ Novo Filamento</button>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('estoque')">üì¶ Estoque</button>
            <button class="nav-tab" onclick="switchTab('uso')">‚ûñ Registrar Uso</button>
            <button class="nav-tab" onclick="switchTab('impressoras')">üñ®Ô∏è Impressoras</button>
            <button class="nav-tab" onclick="switchTab('qrcode')">üì± QR Code</button>
            <button class="nav-tab" onclick="switchTab('calculadora')">üí∞ Calculadora</button>
            <button class="nav-tab" onclick="switchTab('ferramentas')">‚öôÔ∏è Ferramentas</button>
        </div>

        <!-- ABA ESTOQUE -->
        <div id="estoque" class="tab-content active">
            <div class="filters">
                <input type="text" id="searchInput" placeholder="Buscar..." onkeyup="filterFilaments()">
                <select id="colorFilter" onchange="filterFilaments()">
                    <option value="">Todas as cores</option>
                </select>
                <select id="statusFilter" onchange="filterFilaments()">
                    <option value="">Todos os status</option>
                    <option value="em_uso">Em Uso</option>
                    <option value="lacrado">Lacrado</option>
                </select>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
            <div class="grid" id="filamentGrid"></div>
        </div>

        <!-- ABA REGISTRAR USO -->
        <div id="uso" class="tab-content">
            <div class="card">
                <h2>Registrar Uso de Filamento</h2>
                <p style="color: var(--gray); margin: 10px 0 20px;">Registre at√© 4 filamentos sendo usados simultaneamente</p>

                <div class="form-group">
                    <label>Selecione a Impressora:</label>
                    <select id="usoPrinter" required>
                        <option value="">-- Selecione --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data da Impress√£o:</label>
                    <input type="date" id="usoData" required>
                </div>

                <div class="form-group">
                    <label>Nome da Pe√ßa:</label>
                    <input type="text" id="usoNomePeca" placeholder="Ex: Suporte para celular">
                </div>

                <!-- SLOTS -->
                <div id="slotsContainer"></div>

                <button class="btn-success" onclick="registrarUsos()" style="width: 100%; padding: 15px; font-size: 1em; margin-top: 20px;">‚úì Registrar Usos</button>
            </div>

            <div class="card" style="margin-top: 25px;">
                <h3>Hist√≥rico Recente</h3>
                <div id="usageList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- ABA IMPRESSORAS -->
        <div id="impressoras" class="tab-content">
            <div class="card">
                <h2>Gerenciar Impressoras</h2>
                <button class="btn-primary" onclick="openPrinterModal()" style="margin-bottom: 20px;">+ Adicionar Impressora</button>

                <div class="grid" id="printersGrid"></div>
            </div>
        </div>

        <!-- ABA QR CODE -->
        <div id="qrcode" class="tab-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                <div class="card">
                    <h3>üîç Scanner QR</h3>
                    <div id="scanner"></div>
                    <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="startScanning()">Iniciar</button>
                    <button class="btn-secondary" style="width: 100%; margin-top: 8px;" onclick="stopScanning()">Parar</button>
                    <div id="scanResult"></div>
                </div>

                <div class="card">
                    <h3>üì± Gerar QR Code</h3>
                    <div class="form-group">
                        <label>Selecione Filamento:</label>
                        <select id="qrFilament" onchange="generateQR()">
                            <option value="">-- Selecione --</option>
                        </select>
                    </div>
                    <div id="qrOutput" style="display: none; text-align: center;">
                        <div id="qrcode-generator"></div>
                        <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="printQR()">üñ®Ô∏è Imprimir</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA CALCULADORA -->
        <div id="calculadora" class="tab-content">
            <div class="card">
                <h2>üí∞ Calculadora de Pre√ßo</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Custo Material (R$):</label>
                        <input type="number" id="calcMaterial" step="0.01" onchange="calcularPreco()">
                    </div>
                    <div class="form-group">
                        <label>Tempo (horas):</label>
                        <input type="number" id="calcTempo" step="0.1" onchange="calcularPreco()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Custo Energia/h (R$):</label>
                        <input type="number" id="calcEnergia" step="0.01" value="0.50" onchange="calcularPreco()">
                    </div>
                    <div class="form-group">
                        <label>Custo MO/h (R$):</label>
                        <input type="number" id="calcMO" step="0.01" value="50" onchange="calcularPreco()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Margem Lucro (%):</label>
                        <input type="number" id="calcMargem" value="40" onchange="calcularPreco()">
                    </div>
                </div>
                <div id="calcResult" style="display: none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 25px; border-radius: 8px; margin-top: 20px; text-align: center;">
                    <div style="font-size: 0.9em; opacity: 0.9;">PRE√áO RECOMENDADO</div>
                    <div style="font-size: 3em; font-weight: bold; margin: 10px 0;" id="calcPreco">R$ 0,00</div>
                </div>
            </div>
        </div>

        <!-- ABA FERRAMENTAS -->
        <div id="ferramentas" class="tab-content">
            <div class="card">
                <h2>‚öôÔ∏è Ferramentas</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn-primary" onclick="exportJSON()">üì• Exportar JSON</button>
                    <button class="btn-secondary" onclick="importData()">üì§ Importar</button>
                    <button class="btn-secondary" onclick="clearDB()">üóëÔ∏è Limpar Dados</button>
                    <button class="btn-secondary" onclick="showStats()">üìä Estat√≠sticas</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
            </div>
        </div>
    </div>

    <!-- MODAIS -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2>Adicionar Filamento</h2>
            <form onsubmit="saveFilament(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Cor Dominante:</label>
                        <input type="text" required>
                    </div>
                    <div class="form-group">
                        <label>Modelo:</label>
                        <input type="text" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Marca:</label>
                        <input type="text" required>
                    </div>
                    <div class="form-group">
                        <label>Material:</label>
                        <select required>
                            <option value="">Selecione</option>
                            <option value="PLA">PLA</option>
                            <option value="PETG">PETG</option>
                            <option value="ABS">ABS</option>
                            <option value="TPU">TPU</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Foto:</label>
                    <input type="file" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Pre√ßo (R$):</label>
                    <input type="number" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Peso Balan√ßa (g):</label>
                    <input type="number" required>
                </div>
                <div class="form-group">
                    <label>Local:</label>
                    <select required>
                        <option value="Prateleira A1">Prateleira A1</option>
                        <option value="Prateleira A2">Prateleira A2</option>
                        <option value="Prateleira B1">Prateleira B1</option>
                        <option value="Arm√°rio C">Arm√°rio C</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeAddModal()" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="printerModal" class="modal">
        <div class="modal-content">
            <h2>Adicionar Impressora</h2>
            <form onsubmit="savePrinter(event)">
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" required>
                </div>
                <div class="form-group">
                    <label>Marca/Modelo:</label>
                    <input type="text" placeholder="Ex: Creality Ender 3">
                </div>
                <div class="form-group">
                    <label>Di√¢metro Filamento (mm):</label>
                    <select required>
                        <option value="1.75">1,75 MM</option>
                        <option value="2.85">2,85 MM</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closePrinterModal()" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============ IndexedDB Setup ============
        let db;
        const dbName = 'meuEstoque3D';
        const stores = ['filamentos', 'impressoras', 'uso_historico', 'qrcodes'];

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onerror = () => reject(request.error);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    stores.forEach(store => {
                        if (!db.objectStoreNames.contains(store)) {
                            db.createObjectStore(store, { keyPath: 'id', autoIncrement: true });
                        }
                    });
                };
                request.onsuccess = () => {
                    db = request.result;
                    resolve();
                };
            });
        }

        async function saveToIDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.put(data);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function getAllFromIDB(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        async function deleteFromIDB(storeName, id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.delete(id);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        // ============ UI Functions ============
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');

            if (tab === 'uso') renderSlots();
            if (tab === 'impressoras') renderPrinters();
            if (tab === 'qrcode') populateQRSelect();
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============ Filamentos ============
        async function renderFilaments() {
            const filaments = await getAllFromIDB('filamentos');
            const grid = document.getElementById('filamentGrid');

            if (!filaments.length) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--gray);">Nenhum filamento</p>';
                return;
            }

            grid.innerHTML = filaments.map(f => `
                <div class="card">
                    ${f.fotoBlob ? `<img src="${f.fotoBlob}" class="card-image" alt="Foto">` : '<div class="card-image" style="background: var(--light);">üì¶</div>'}
                    <h3>${f.modelo}</h3>
                    <p>${f.marca}</p>
                    <p style="color: var(--gray); font-size: 0.9em;">üìç ${f.local}</p>
                    <p style="margin: 10px 0;"><strong>R$ ${f.preco.toFixed(2)}</strong></p>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="btn-secondary btn-small" onclick="editFilament(${f.id})">Editar</button>
                        <button class="btn-danger btn-small" onclick="deleteFilament(${f.id})">Deletar</button>
                    </div>
                </div>
            `).join('');
        }

        function filterFilaments() {
            // TODO: Implementar filtros
        }

        async function saveFilament(e) {
            e.preventDefault();
            const form = e.target;
            const inputs = form.querySelectorAll('input, select');
            const fileInput = form.querySelector('input[type="file"]');

            let fotoBlob = null;
            if (fileInput.files.length) {
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    fotoBlob = evt.target.result;
                    await saveFilament2(inputs, fotoBlob);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                await saveFilament2(inputs, fotoBlob);
            }
        }

        async function saveFilament2(inputs, fotoBlob) {
            const data = {
                cor_dominante: inputs[0].value,
                modelo: inputs[1].value,
                marca: inputs[2].value,
                material: inputs[3].value,
                preco: parseFloat(inputs[5].value),
                peso_balanca: parseFloat(inputs[6].value),
                local: inputs[7].value,
                fotoBlob: fotoBlob
            };

            await saveToIDB('filamentos', data);
            showToast('Filamento salvo!');
            closeAddModal();
            renderFilaments();
        }

        async function deleteFilament(id) {
            if (confirm('Deletar?')) {
                await deleteFromIDB('filamentos', id);
                renderFilaments();
            }
        }

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        // ============ Impressoras ============
        async function renderPrinters() {
            const printers = await getAllFromIDB('impressoras');
            const grid = document.getElementById('printersGrid');

            grid.innerHTML = printers.map(p => `
                <div class="card">
                    <h3>üñ®Ô∏è ${p.nome}</h3>
                    <p>${p.modelo}</p>
                    <p style="color: var(--gray); font-size: 0.9em;">Di√¢metro: ${p.diametro}mm</p>
                    <button class="btn-danger btn-small" onclick="deletePrinter(${p.id})" style="width: 100%; margin-top: 10px;">Deletar</button>
                </div>
            `).join('');
        }

        async function savePrinter(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                nome: form.querySelector('input').value,
                modelo: form.querySelectorAll('input')[1].value,
                diametro: parseFloat(form.querySelector('select').value)
            };

            await saveToIDB('impressoras', data);
            showToast('Impressora salva!');
            closePrinterModal();
            renderPrinters();
            populateUsoPrinters();
        }

        async function deletePrinter(id) {
            if (confirm('Deletar impressora?')) {
                await deleteFromIDB('impressoras', id);
                renderPrinters();
            }
        }

        function openPrinterModal() {
            document.getElementById('printerModal').classList.add('active');
        }

        function closePrinterModal() {
            document.getElementById('printerModal').classList.remove('active');
        }

        // ============ Registrar Uso ============
        async function populateUsoPrinters() {
            const printers = await getAllFromIDB('impressoras');
            const select = document.getElementById('usoPrinter');
            select.innerHTML = '<option value="">-- Selecione --</option>';
            printers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = p.nome;
                select.appendChild(opt);
            });
        }

        async function renderSlots() {
            const filaments = await getAllFromIDB('filamentos');
            const container = document.getElementById('slotsContainer');

            let html = '';
            for (let i = 1; i <= 4; i++) {
                html += `
                    <div class="slot-group">
                        <div class="slot-label">Slot ${i}</div>
                        <select id="slot${i}" onchange="updateSlot(${i})">
                            <option value="">Nenhum</option>
                            ${filaments.map(f => `<option value="${f.id}">${f.modelo}</option>`).join('')}
                        </select>
                        <input type="number" id="peso${i}" placeholder="Peso (g)" step="0.1" style="margin-top: 8px; width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;">
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        async function registrarUsos() {
            const printerId = document.getElementById('usoPrinter').value;
            const data = document.getElementById('usoData').value;
            const nomePeca = document.getElementById('usoNomePeca').value;

            if (!printerId || !data) {
                showToast('Preencha impressora e data');
                return;
            }

            const usos = [];
            for (let i = 1; i <= 4; i++) {
                const filamentoId = document.getElementById(`slot${i}`).value;
                const peso = parseFloat(document.getElementById(`peso${i}`).value) || 0;

                if (filamentoId && peso > 0) {
                    usos.push({
                        printerId: parseInt(printerId),
                        filamentoId: parseInt(filamentoId),
                        peso: peso,
                        data: data,
                        nomePeca: nomePeca,
                        timestamp: new Date().toISOString()
                    });
                }
            }

            if (!usos.length) {
                showToast('Preencha pelo menos um slot');
                return;
            }

            for (const uso of usos) {
                await saveToIDB('uso_historico', uso);
            }

            showToast(`${usos.length} uso(s) registrado(s)!`);
            renderUsoHistory();
        }

        async function renderUsoHistory() {
            const history = await getAllFromIDB('uso_historico');
            const list = document.getElementById('usageList');

            list.innerHTML = history.slice(-20).reverse().map(u => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                    <p><strong>${u.nomePeca || 'Sem nome'}</strong></p>
                    <p style="font-size: 0.85em; color: var(--gray);">Printer ID: ${u.printerId} | Filamento ID: ${u.filamentoId} | ${u.peso}g</p>
                    <p style="font-size: 0.85em; color: var(--gray);">${new Date(u.data).toLocaleDateString('pt-BR')}</p>
                </div>
            `).join('');
        }

        // ============ QR Code ============
        let scannerInstance = null;

        async function populateQRSelect() {
            const filaments = await getAllFromIDB('filamentos');
            const select = document.getElementById('qrFilament');
            select.innerHTML = '<option value="">-- Selecione --</option>';
            filaments.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.text = f.modelo;
                select.appendChild(opt);
            });
        }

        async function generateQR() {
            const filamentoId = document.getElementById('qrFilament').value;
            if (!filamentoId) return;

            const filaments = await getAllFromIDB('filamentos');
            const filamento = filaments.find(f => f.id == filamentoId);

            const qrData = JSON.stringify({
                id: filamento.id,
                modelo: filamento.modelo,
                marca: filamento.marca,
                local: filamento.local
            });

            document.getElementById('qrcode-generator').innerHTML = '';
            new QRCode(document.getElementById('qrcode-generator'), {
                text: qrData,
                width: 256,
                height: 256
            });

            document.getElementById('qrOutput').style.display = 'block';
        }

        async function startScanning() {
            try {
                const html5QrCode = new Html5Qrcode("scanner");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
                scannerInstance = html5QrCode;
            } catch (err) {
                showToast('Erro ao acessar c√¢mera: ' + err);
            }
        }

        function stopScanning() {
            if (scannerInstance) {
                scannerInstance.stop().then(() => {
                    scannerInstance = null;
                }).catch(() => {});
            }
        }

        async function onScanSuccess(decodedText) {
            try {
                const data = JSON.parse(decodedText);
                const result = document.getElementById('scanResult');
                result.innerHTML = `
                    <div class="scan-result">
                        <p><strong>‚úì Encontrado!</strong></p>
                        <p>${data.modelo}</p>
                        <p>${data.marca}</p>
                        <p>üìç ${data.local}</p>
                    </div>
                `;
                showToast('QR Code detectado!');
            } catch (e) {}
        }

        function printQR() {
            const qrcodeHtml = document.getElementById('qrcode-generator').innerHTML;
            const printWindow = window.open('', '', 'height=400,width=400');
            printWindow.document.write(`
                <html>
                <head><title>QR Code</title><style>body {text-align: center; padding: 20px;}</style></head>
                <body>
                    <h3>Estoquefilamento</h3>
                    ${qrcodeHtml}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ============ Calculadora ============
        function calcularPreco() {
            const material = parseFloat(document.getElementById('calcMaterial').value) || 0;
            const tempo = parseFloat(document.getElementById('calcTempo').value) || 0;
            const energia = parseFloat(document.getElementById('calcEnergia').value) || 0.5;
            const mo = parseFloat(document.getElementById('calcMO').value) || 50;
            const margem = parseFloat(document.getElementById('calcMargem').value) || 40;

            const custoEnergia = tempo * energia;
            const custoMO = tempo * mo;
            const subtotal = material + custoEnergia + custoMO;
            const lucro = subtotal * (margem / 100);
            const preco = subtotal + lucro;

            document.getElementById('calcResult').style.display = 'block';
            document.getElementById('calcPreco').textContent = `R$ ${preco.toFixed(2)}`;
        }

        // ============ Import/Export ============
        async function exportJSON() {
            const filamentos = await getAllFromIDB('filamentos');
            const impressoras = await getAllFromIDB('impressoras');
            const uso = await getAllFromIDB('uso_historico');

            const data = { filamentos, impressoras, uso };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('Backup exportado!');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        async function handleImport(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const data = JSON.parse(evt.target.result);
                    if (data.filamentos) {
                        for (const f of data.filamentos) await saveToIDB('filamentos', f);
                    }
                    if (data.impressoras) {
                        for (const p of data.impressoras) await saveToIDB('impressoras', p);
                    }
                    if (data.uso) {
                        for (const u of data.uso) await saveToIDB('uso_historico', u);
                    }
                    showToast('Dados importados!');
                    renderFilaments();
                    renderPrinters();
                    renderUsoHistory();
                } catch (err) {
                    showToast('Erro ao importar');
                }
            };
            reader.readAsText(file);
        }

        async function clearDB() {
            if (confirm('Deletar TUDO?')) {
                for (const store of stores) {
                    const items = await getAllFromIDB(store);
                    for (const item of items) {
                        await deleteFromIDB(store, item.id);
                    }
                }
                showToast('Dados deletados!');
                renderFilaments();
            }
        }

        // ============ Inicializa√ß√£o ============
        document.getElementById('usoData').valueAsDate = new Date();

        async function init() {
            await initDB();
            renderFilaments();
            populateUsoPrinters();
            renderUsoHistory();
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
